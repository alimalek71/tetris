(()=>{var Le=Object.create;var j=Object.defineProperty;var be=Object.getOwnPropertyDescriptor;var Te=Object.getOwnPropertyNames;var Me=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var Ce=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var g=(e,t)=>()=>(e&&(t=e(e=0)),t);var _e=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Be=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Te(t))!Oe.call(e,o)&&o!==n&&j(e,o,{get:()=>t[o],enumerable:!(r=be(t,o))||r.enumerable});return e};var De=(e,t,n)=>(n=e!=null?Le(Me(e)):{},Be(t||!e||!e.__esModule?j(n,"default",{value:e,enumerable:!0}):n,e));var x,q=g(()=>{x=class{constructor(t=10,n=20){this.width=t,this.height=n,this.reset()}reset(){this.grid=Array.from({length:this.height},()=>Array(this.width).fill(0))}inside(t,n){return t>=0&&t<this.width&&n>=0&&n<this.height}merge(t){t.matrix.forEach((n,r)=>{n.forEach((o,s)=>{if(o){let c=t.y+r,h=t.x+s;this.inside(h,c)&&(this.grid[c][h]=t.color)}})})}clearLines(){let t=0;for(let n=this.height-1;n>=0;n-=1)this.grid[n].every(r=>r!==0)&&(this.grid.splice(n,1),this.grid.unshift(Array(this.width).fill(0)),t+=1,n+=1);return t}}});function A(e){if(e==null){_=Math.random;return}let t=e>>>0;_=function(){t=t+1831565813|0;let n=Math.imul(t^t>>>15,1|t);return n^=n+Math.imul(n^n>>>7,61|n),((n^n>>>14)>>>0)/4294967296}}function k(e){let t=e.length,n=e[0].length,r=Array.from({length:n},()=>Array(t).fill(0));for(let o=0;o<t;o+=1)for(let s=0;s<n;s+=1)r[s][t-1-o]=e[o][s];return r}function D(){let e=Object.keys(z),t=e[_()*e.length|0];return new B(t)}var z,Re,_,B,V=g(()=>{z={I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],J:[[1,0,0],[1,1,1],[0,0,0]],L:[[0,0,1],[1,1,1],[0,0,0]],O:[[1,1],[1,1]],S:[[0,1,1],[1,1,0],[0,0,0]],T:[[0,1,0],[1,1,1],[0,0,0]],Z:[[1,1,0],[0,1,1],[0,0,0]]},Re={I:"cyan",J:"blue",L:"orange",O:"yellow",S:"green",T:"purple",Z:"red"},_=Math.random;B=class{constructor(t){this.type=t,this.matrix=z[t].map(n=>n.slice()),this.color=Re[t],this.x=3,this.y=0}rotate(){this.matrix=k(this.matrix)}rotateBack(){this.matrix=k(k(k(this.matrix)))}}});var E,W=g(()=>{E=class{constructor(){this.reset()}reset(){this.score=0,this.level=0,this.lines=0}calculateScore(t){return({1:40,2:100,3:300,4:1200}[t]||0)*(this.level+1)}addLines(t){if(!t)return!1;this.score+=this.calculateScore(t),this.lines+=t;let n=Math.floor(this.lines/10),r=n>this.level;return this.level=n,r}}});function Q(){try{let e=localStorage.getItem(R);if(!e||e.length>5e4)return[];let t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function Ne(e){try{let t=JSON.stringify(e);if(t.length>5e4)return;localStorage.setItem(R,t)}catch{}}function ee(e,t){let n=Q();n.push({name:e,score:t,date:new Date().toISOString()}),n.sort((r,o)=>o.score-r.score),n.length>10&&(n.length=10),Ne(n)}function Ge(e=10){let t=Q();return t.sort((n,r)=>r.score-n.score),t.slice(0,e)}function Xe(){localStorage.removeItem(R)}function te(e=10){let t=document.getElementById("leaderboard-list");if(!t)return;let n=Ge(e);t.innerHTML="",n.forEach(r=>{let o=document.createElement("li"),s=new Date(r.date).toLocaleDateString();o.textContent=`${r.name} - ${r.score} (${s})`,t.appendChild(o)})}function ne(e=10){te(e);let t=document.getElementById("leaderboard-modal");t&&t.classList.add("show")}function Ke(){let e=document.getElementById("leaderboard-modal");e&&e.classList.remove("show")}function re(){let e=document.getElementById("close-leaderboard"),t=document.getElementById("clear-leaderboard");e&&e.addEventListener("click",Ke),t&&t.addEventListener("click",()=>{Xe(),te()})}var R,oe=g(()=>{R="tetrisLeaderboard"});function S(e,t={}){let n={key:ie,event:e,data:t,timestamp:Date.now()};console.log("Tracking event",n)}var ie,se=g(()=>{ie="dummy-key";import("./config.js").then(e=>{e.TRACKING_KEY&&(ie=e.TRACKING_KEY)}).catch(()=>{})});function Pe(){try{let e=JSON.parse(localStorage.getItem(ae)||"{}");Object.keys(e).forEach(t=>{d[t]&&(d[t].unlocked=!0)})}catch{}}function ce(){let e={};Object.keys(d).forEach(t=>{d[t].unlocked&&(e[t]=!0)}),localStorage.setItem(ae,JSON.stringify(e))}function X(){let e=document.getElementById("achievement-list");e&&(e.innerHTML="",Object.keys(d).forEach(t=>{let n=d[t],r=document.createElement("li");r.textContent=n.name,r.className=n.unlocked?"unlocked":"locked",e.appendChild(r)}))}function de(){Pe(),X(),v()}function ue(){G=Date.now(),N.tetrises=0}function fe(e){e===4&&(N.tetrises+=1,!d.tetris10.unlocked&&N.tetrises>=10&&(d.tetris10.unlocked=!0,ce(),X()))}function he(e){e>=5&&G&&!d.fast5.unlocked&&Date.now()-G<=12e4&&(d.fast5.unlocked=!0,ce(),X())}function K(){return new Date().toISOString().slice(0,10)}function me(){let e=K(),t=0;for(let n=0;n<e.length;n+=1)t=(t<<5)-t+e.charCodeAt(n),t|=0;return t>>>0}function ge(){return!!I[K()]}function He(){I[K()]=!0,localStorage.setItem(le,JSON.stringify(I)),v()}function v(){let e=document.getElementById("daily-status");e&&(e.textContent=ge()?"Completed":"Incomplete")}function ye(e){e&&!ge()&&He()}var d,ae,le,N,G,I,pe=g(()=>{d={tetris10:{name:"Tetris x10",desc:"Clear 10 Tetrises",unlocked:!1},fast5:{name:"Level 5 Speedrun",desc:"Reach level 5 in under 2 mins",unlocked:!1}},ae="tetris_achievements",le="tetris_daily",N={tetrises:0},G=null;I={};try{I=JSON.parse(localStorage.getItem(le)||"{}")}catch{}});var ze=_e(()=>{q();V();W();oe();se();pe();var m=document.getElementById("game"),a=m.getContext("2d"),l=new x(10,20),u=new E,f=30;function Ee(){let e=Math.floor(Math.min(window.innerWidth/l.width,window.innerHeight/l.height));m.width=e*l.width,m.height=e*l.height,f=e}window.addEventListener("resize",Ee);Ee();var i=D(),H=0,J=1e3,$=J,U=0,Y=null,y=!1,p=!1,Je=document.getElementById("hud"),$e=document.getElementById("start"),Ue=document.getElementById("pause"),P=document.getElementById("sound-toggle"),xe=document.getElementById("daily-start");re();de();var T=!1;$e.addEventListener("click",()=>{T=!1,A(),Ae()});Ue.addEventListener("click",qe);var Z={},F=!1,L=!0;xe&&xe.addEventListener("click",()=>{T=!0,A(me()),l.reset(),u.reset(),Ae(),v()});function M(e){if(!F||!L)return;let t=Z[e];t&&(t.currentTime=0,t.play().catch(()=>{}))}async function Ye(){let e=async(t,n)=>{try{(await fetch(n,{method:"HEAD"})).ok&&(Z[t]=new Audio(n))}catch{}};await Promise.all([e("move","./assets/sfx/move.wav"),e("rotate","./assets/sfx/rotate.wav"),e("line","./assets/sfx/line.wav")]),F=Object.keys(Z).length>0,F&&(P.style.display="inline-block",P.addEventListener("click",()=>{L=!L,P.textContent=L?"Mute":"Unmute"}))}Ye();function w(e,t,n){e.forEach((r,o)=>{r.forEach((s,c)=>{if(s){let h=n||s;a.fillStyle=h,a.fillRect((c+t.x)*f,(o+t.y)*f,f,f),a.strokeStyle="#000",a.strokeRect((c+t.x)*f,(o+t.y)*f,f,f)}})})}function Se(){let e={x:i.x,y:i.y,matrix:i.matrix};for(;!O(l,e,0,1);)e.y+=1;return e}function ve(){a.fillStyle="#000",a.fillRect(0,0,m.width,m.height),w(l.grid,{x:0,y:0},null);let e=Se();a.save(),a.globalAlpha=.3,w(e.matrix,{x:e.x,y:e.y},i.color),a.restore(),w(i.matrix,{x:i.x,y:i.y},i.color)}function O(e,t,n=0,r=0){let o=t.matrix;for(let s=0;s<o.length;s+=1)for(let c=0;c<o[s].length;c+=1)if(o[s][c]){let h=t.x+c+n,C=t.y+s+r;if(h<0||h>=e.width||C>=e.height||C>=0&&e.grid[C][h])return!0}return!1}function Ze(){l.merge(i);let e=l.clearLines();e&&(M("line"),S("line_clear",{lines:e})),fe(e);let t=u.addLines(e);if(he(u.level),t&&($=Math.max(100,J-u.level*100),S("level_up",{level:u.level})),i=D(),O(l,i)){let n=u.score;S("game_over",{score:n});let r=prompt("Enter your name")||"Anonymous";ee(r,n),ne(),l.reset(),u.reset(),$=J,ye(T),T=!1,v(),A()}}function b(e,t,n=!1){p||(O(l,i,e,t)?t===1&&(n&&M("move"),we()):(i.x+=e,i.y+=t,n&&M("move")),H=0)}function Fe(e=!1){p||(i.rotate(),O(l,i)?i.rotateBack():e&&M("rotate"))}function we(){p=!0;let e={matrix:i.matrix.map(r=>r.slice()),x:i.x,y:i.y,color:i.color},t=1;function n(){a.fillStyle="#000",a.fillRect(0,0,m.width,m.height),w(l.grid,{x:0,y:0},null),a.save(),a.globalAlpha=t,w(e.matrix,{x:e.x,y:e.y},e.color),a.restore(),t-=.1,t>0?requestAnimationFrame(n):(i=e,Ze(),p=!1)}n()}document.addEventListener("keydown",e=>{if(y)switch(e.key){case"ArrowLeft":b(-1,0,!0);break;case"ArrowRight":b(1,0,!0);break;case"ArrowDown":b(0,1,!0);break;case"ArrowUp":Fe(!0);break;case" ":je();break;default:break}});function je(){if(p)return;let t=Se().y-i.y;function n(){t>0?(i.y+=1,t-=1,ve(),requestAnimationFrame(n)):we()}n()}function ke(){Je.innerHTML=`Score: ${u.score}<br>Level: ${u.level}<br>Lines: ${u.lines}`}function Ae(){y||(ue(),y=!0,U=0,S("game_start"),Ie())}function qe(){y&&(y=!1,Y&&cancelAnimationFrame(Y))}function Ie(e=0){if(!y)return;let t=e-U;U=e,H+=t,p||(H>$&&b(0,1),ve()),ke(),Y=requestAnimationFrame(Ie)}ke()});ze();})();
